#include "contiki.h"
#include "CuTest.h"
#include <stdio.h>
#include <string.h>
#include "obex.h"
static void mas_callback(int code, void* lparam, uint16_t rparam);
static void mas_send(void* lparam, uint16_t rparam);
static struct obex_state mas_obex_state;
static const struct obex mas_obex = 
{
  &mas_obex_state, mas_callback, mas_send
};
static void mas_callback(int code, void* lparam, uint16_t rparam)
{
  printf("obex event : %d\n", code);
  hexdump(lparam, rparam);
}

static void mas_send(void* lparam, uint16_t rparam)
{
  hexdump(lparam, rparam);
}
static const uint8_t appparams_notify[] = 
{
  0x0e, 0x01,0x01
};
static const uint8_t MAS_TARGET[16] =
{
 0xbb, 0x58, 0x2b, 0x40, 0x42, 0x0c, 0x11, 0xdb, 0xb0, 0xde, 0x08, 0x00, 0x20, 0x0c, 0x9a, 0x66
};
static const char type_notify[] = "x-bt/MAP-NotificationRegistration";

void testobex(CuTest* tc)
{
  obex_init(&mas_obex);
  obex_connect_request(&mas_obex, MAS_TARGET, sizeof(MAS_TARGET));

  uint8_t data[] = {
    0xA0, 0x00, 0x1F , 0x10 , 0x00 , 0x0F , 0xA0 , 0xCB , 0x00 , 0x1D , 0x91 ,
    0x18 , 0x4A , 0x00 , 0x13 , 0xBB , 0x58 , 0x2B , 0x40 , 0x42 , 0x0C , 0x11 , 
    0xDB , 0xB0 , 0xDE , 0x08 , 0x00 , 0x20 , 0x0C , 0x9A , 0x66
  };

uint8_t data1[] = {0x82,0x00,0xBE,0xCB,0x00,0x12,0x34,0x56,0x42,0x00,0x19,0x78,0x2D,0x62,0x74,0x2F,0x4D,0x41,0x50,0x2D,0x65,0x76,0x65,0x6E,0x74,0x2D,0x72,0x65,0x70,0x6F,0x72,0x74,0x00,0x4C,0x00,0x06,0x0F,0x01,0x00,0x49,0x00,0x97,0x3C};
uint8_t data2[] = {0x4D,0x41,0x50,0x2D,0x65,0x76,0x65,0x6E,0x74,0x2D,0x72,0x65,0x70,0x6F,0x72,0x74,0x20,0x76,0x65,0x72,0x73,0x69,0x6F,0x6E,0x20,0x3D,0x20,0x22,0x31,0x2E,0x30,0x22,0x3E,0x3C,0x65,0x76,0x65,0x6E,0x74,0x20,0x74,0x79,0x70,
0x65,0x20,0x3D,0x20,0x22,0x4E,0x65,0x77,0x4D,0x65,0x73,0x73,0x61,0x67,0x65,0x22,0x20,0x68,0x61,0x6E,0x64,0x6C,0x65,0x20,0x3D,0x20,0x22,0x31,0x30,0x30,0x31,0x22,0x20,0x66,0x6F,0x6C,0x64,0x65,0x72,0x20,0x3D,0x20,0x22,
0x74,0x65,0x6C,0x65,0x63,0x6F,0x6D,0x2F,0x6D,0x73,0x67,0x2F,0x69,0x6E,0x62,0x6F,0x78,0x22,0x20,0x6D,0x73,0x67,0x5F,0x74,0x79,0x70,0x65,0x20,0x3D,0x20,0x22,0x53,0x4D,0x53,0x5F,0x47,0x53,0x4D,0x22,0x20,0x2F,0x3E,0x3C,
0x2F,0x4D,0x41,0x50,0x2D,0x65,0x76,0x65,0x6E,0x74,0x2D,0x72,0x65,0x70,0x6F,0x72,0x74,0x3E};

  obex_handle(&mas_obex, data, sizeof(data));

  uint8_t buf[256];
  uint8_t *ptr = obex_create_request(&mas_obex, OBEX_OP_PUT, buf);
  uint8_t Fillerbyte = 0x30;
  
  ptr = obex_header_add_bytes(ptr, OBEX_HEADER_TYPE, (uint8_t*)type_notify, sizeof(type_notify));
  ptr = obex_header_add_bytes(ptr, OBEX_HEADER_APPPARMS, appparams_notify, sizeof(appparams_notify));
  ptr = obex_header_add_bytes(ptr, OBEX_HEADER_ENDBODY, &Fillerbyte, 1);
    
  obex_send_request(&mas_obex, buf, ptr - &buf[0]);

  obex_handle(&mas_obex, data1, sizeof(data1));
  obex_handle(&mas_obex, data2, sizeof(data2));

}



/*
 * Parse content-type = x-bt/message
 */
static const char BEGINMSG[] = "BEGIN:MSG";
static const char BEGINTYPE[] = "TYPE:";
static const char BEGINFN[] = "FN;CHARSET=UTF-8:";
static const char END[] = "\r\n";
static char content[120];
static char title[20];
static uint8_t content_type, content_size;

#define ICON_FACEBOOK 's'
#define ICON_TWITTER  't'
#define ICON_MSG      'u'
static enum {
  STATE_INIT,
  STATE_GETTYPE,
  STATE_GETFROM,
  STATE_GETCONTENTSTART,
  STATE_GETCONTENTEND,

  STATE_ERROR
}state;

static void msg_gettype(char* buf)
{
  content[0] = 0;
  content_size = sizeof(content) - 1;

  // identify the type
  char* start = strstr(buf, BEGINTYPE);
  char* end = strstr(start, END);

  if (start == NULL || end == NULL)
  {
    state = STATE_ERROR;
    return;
  }

  if (strncmp(start + sizeof(BEGINTYPE) - 1, "SMS", 3) == 0)
  {
    content_type = ICON_MSG;
  }
  else
    content_type = 0;

//  state = STATE_GETTYPE;

// assume this must be in same package
  start = strstr(end, BEGINFN);
  end = strstr(start, END);

  if (start == NULL || end == NULL)
  {
    state = STATE_ERROR;
    return;
  }

  start += sizeof(BEGINFN) - 1;

  size_t size;
  if (end - start < sizeof(title) - 1)
    size = end - start;
  else
    size = sizeof(title) - 1;


  memcpy(title, start, size);
  title[size] = 0;

  state = STATE_GETFROM;
}

static void msg_getcontent(char *buf)
{
  char* start;
  char* stop;
  if (state == STATE_GETCONTENTSTART)
  {
    start = buf;
    stop = strstr(start, "END:MSG");
    if (stop != NULL)
    {
      state = STATE_GETCONTENTEND;
      *stop = '\0';
    }
  }
  else
  {
    start = strstr(buf, BEGINMSG);
    int length;
    if (start == NULL)
      return;
    state = STATE_GETCONTENTSTART;

    stop = strstr(start, "END:MSG");
    if (stop != NULL)
    {
      state = STATE_GETCONTENTEND;
      *stop = '\0';
    }
    start += sizeof(BEGINMSG) - 1;
  }

  size_t size;
  if (stop - start < content_size)
    size = stop - start;
  else
    size = content_size;

  strncat(content, start, size);
  content_size -= size;

  if (content_size < 0)
  {
    state = STATE_GETCONTENTEND;
  }
}
char emailbuf[] = "BEGIN:BMSG\r\nTYPE:SMS_GSM\r\nFN;CHARSET=UTF-8:Joachim\r\nBEGIN:MSG\r\nthisis msg\r\nEND:MSG\r\nEND:BMSG";
char buf0[] = {
0x42,0x45,0x47,0x49,0x4e,0x3a,0x42,0x4d,0x53,0x47
,0x56,0x45,0x52,0x53,0x49,0x4f,0x4e,0x3a,0x31,0x2e,0x30,0x53,0x54,0x41,0x54
,0x55,0x53,0x3a,0x55,0x4e,0x52,0x45,0x41,0x44
,0x54,0x59,0x50,0x45,0x3a,0x53,0x4d,0x53,0x5f,0x47,0x53,0x4d,0x46,0x4f
,0x4c,0x44,0x45,0x52,0x3a,0x74,0x65,0x6c,0x65,0x63,0x6f,0x6d,0x2f,0x6d,0x73,0x67,0x2f,0x69,0x6e,0x62,0x6f,0x78
,0x4e,0x4f,0x54,0x49,0x46,0x49,0x43,0x41,0x54,0x49,0x4f,0x4e,0x3a,0x31
,0x42,0x45,0x47,0x49,0x4e,0x3a,0x56,0x43,0x41,0x52,0x44
,0x56,0x45,0x52,0x53,0x49,0x4f,0x4e,0x3a,0x32,0x2e,0x31
,0x46,0x4e,0x3b,0x43,0x48,0x41,0x52,0x53
,0x45,0x54,0x3d,0x55,0x54,0x46,0x2d,0x38,0x3a,0x31,0x30,0x30,0x38,0x36
,0x4e,0x3b,0x43,0x48,0x41,0x52,0x53,0x45,0x54,0x3d,0x55
,0x54,0x46,0x2d,0x38,0x3a,0x31,0x30,0x30,0x38,0x36,0x54,0x45,0x4c,0x3a
,0x45,0x4e,0x44,0x3a,0x56,0x43,0x41,0x52,0x44
,0x42,0x45,0x47,0x49,0x4e,0x3a,0x42,0x45,0x4e,0x56
,0x42,0x45,0x47,0x49,0x4e,0x3a,0x42,0x42,0x4f,0x44,0x59
,0x43,0x48,0x41,0x52,0x53,0x45,0x54,0x3a,0x55,0x54,0x46,0x2d,0x38
,0x4c,0x41,0x4e,0x47,0x55,0x41,0x47,0x45,0x3a,0x55,0x4e,0x4b,0x4e,0x4f,0x57,0x4e 
};
char buf1[] = {
0x4c,0x45,0x4e,0x47,0x54,0x48,0x3a,0x31,0x37,0x34
,0x42,0x45,0x47,0x49,0x4e,0x3a,0x4d,0x53,0x47
,0xe5,0xb0,0x8a,0xe6,0x95,0xac,0xe7,0x9a,0x84,0xe5,0xae,0xa2,0xe6,0x88,0xb7,0xef,0xbc,0x8c,0xe6
,0x82,0xa8,0xe5,0xa5,0xbd,0xef,0xbc,0x81,0xe6,0xac,0xa2,0xe8,0xbf,0x8e,0xe4,0xbd,0xbf,0xe7,0x94
,0xa8,0xe7,0x94,0xb5,0xe5,0xad,0x90,0xe6,0xb8,0xa0,0xe9,0x81,0x93,0xe7,0x9f,0xad,0xe4,0xbf,0xa1,0xe8,0x90,0xa5,0xe4,0xb8,0x9a
,0xe5,0x8e,0x85,0xef,0xbc,0x8c,0xe6,0x82,0xa8,0xe5,0xbd,0x93,0xe5,0x89,0x8d,0xe4,0xbd,0x99,0xe9,0xa2,0x9d,0xe4
,0xb8,0xba,0x36,0x31,0x2e,0x36,0x34,0xe5,0x85,0x83,0xef,0xbc,0x8c,0xef,0xbc,0x88,0xe4,0xbb,0x85
,0xe4,0xbe,0x9b,0xe5,0x8f,0x82,0xe8,0x80,0x83,0xef,0xbc,0x8c,0xe5,0xae,0x9e,0xe9,0x99,0x85,0xe4,0xbb,0xa5,0xe5,0x87,0xba
,0xe8,0xb4,0xa6,0xe5,0x90,0x8e,0xe8,0xb4,0xa6,0xe5,0x8d,0x95,0xe4,0xb8,0xba,0xe5,0x87,0x86,0xef,0xbc,0x89,0xe3,0x80,0x82
,0x45,0x4e,0x44,0x3a,0x4d,0x53,0x47
,0x45,0x4e,0x44,0x3a,0x42,0x42,0x4f,0x44,0x59
,0x45,0x4e,0x44,0x3a
,0x42,0x45,0x4e,0x56
,0x45,0x4e,0x44,0x3a,0x42,0x4d,0x53,0x47
};

void msgparser(CuTest* tc)
{
  state = STATE_INIT;
  msg_gettype(emailbuf);
  msg_getcontent(emailbuf);

  CuAssertIntEquals(tc, state, STATE_GETCONTENTEND);
  printf("%s", title);
  printf("%s", content);


  state = STATE_INIT;
  msg_gettype(buf0);
  msg_getcontent(buf0);
  msg_getcontent(buf1);

  CuAssertIntEquals(tc, state, STATE_GETCONTENTEND);
  printf("%s", title);
  printf("%s", content);
}




CuSuite* obexGetSuite(void)
{
	CuSuite* suite = CuSuiteNew("obex");

	SUITE_ADD_TEST(suite, testobex);
  SUITE_ADD_TEST(suite, msgparser);
  
	return suite;
}

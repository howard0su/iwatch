#include "contiki.h"
#include "CuTest.h"


#include "obex.h"
static void mas_callback(int code, void* lparam, uint16_t rparam);
static void mas_send(void* lparam, uint16_t rparam);
static struct obex_state mas_obex_state;
static const struct obex mas_obex = 
{
  &mas_obex_state, mas_callback, mas_send
};
static void mas_callback(int code, void* lparam, uint16_t rparam)
{
  printf("obex event : %d\n", code);
  hexdump(lparam, rparam);
}

static void mas_send(void* lparam, uint16_t rparam)
{
  hexdump(lparam, rparam);
}
static const uint8_t appparams_notify[] = 
{
  0x0e, 0x01,0x01
};
static const uint8_t MAS_TARGET[16] =
{
 0xbb, 0x58, 0x2b, 0x40, 0x42, 0x0c, 0x11, 0xdb, 0xb0, 0xde, 0x08, 0x00, 0x20, 0x0c, 0x9a, 0x66
};
static const char type_notify[] = "x-bt/MAP-NotificationRegistration";

void testobex(CuTest* tc)
{
  obex_init(&mas_obex);
  obex_connect_request(&mas_obex, MAS_TARGET, sizeof(MAS_TARGET));

  uint8_t data[] = {
    0xA0, 0x00, 0x1F , 0x10 , 0x00 , 0x0F , 0xA0 , 0xCB , 0x00 , 0x1D , 0x91 ,
    0x18 , 0x4A , 0x00 , 0x13 , 0xBB , 0x58 , 0x2B , 0x40 , 0x42 , 0x0C , 0x11 , 
    0xDB , 0xB0 , 0xDE , 0x08 , 0x00 , 0x20 , 0x0C , 0x9A , 0x66
  };

uint8_t data1[] = {0x82,0x00,0xBE,0xCB,0x00,0x12,0x34,0x56,0x42,0x00,0x19,0x78,0x2D,0x62,0x74,0x2F,0x4D,0x41,0x50,0x2D,0x65,0x76,0x65,0x6E,0x74,0x2D,0x72,0x65,0x70,0x6F,0x72,0x74,0x00,0x4C,0x00,0x06,0x0F,0x01,0x00,0x49,0x00,0x97,0x3C};
uint8_t data2[] = {0x4D,0x41,0x50,0x2D,0x65,0x76,0x65,0x6E,0x74,0x2D,0x72,0x65,0x70,0x6F,0x72,0x74,0x20,0x76,0x65,0x72,0x73,0x69,0x6F,0x6E,0x20,0x3D,0x20,0x22,0x31,0x2E,0x30,0x22,0x3E,0x3C,0x65,0x76,0x65,0x6E,0x74,0x20,0x74,0x79,0x70,
0x65,0x20,0x3D,0x20,0x22,0x4E,0x65,0x77,0x4D,0x65,0x73,0x73,0x61,0x67,0x65,0x22,0x20,0x68,0x61,0x6E,0x64,0x6C,0x65,0x20,0x3D,0x20,0x22,0x31,0x30,0x30,0x31,0x22,0x20,0x66,0x6F,0x6C,0x64,0x65,0x72,0x20,0x3D,0x20,0x22,
0x74,0x65,0x6C,0x65,0x63,0x6F,0x6D,0x2F,0x6D,0x73,0x67,0x2F,0x69,0x6E,0x62,0x6F,0x78,0x22,0x20,0x6D,0x73,0x67,0x5F,0x74,0x79,0x70,0x65,0x20,0x3D,0x20,0x22,0x53,0x4D,0x53,0x5F,0x47,0x53,0x4D,0x22,0x20,0x2F,0x3E,0x3C,
0x2F,0x4D,0x41,0x50,0x2D,0x65,0x76,0x65,0x6E,0x74,0x2D,0x72,0x65,0x70,0x6F,0x72,0x74,0x3E};

  obex_handle(&mas_obex, data, sizeof(data));

  uint8_t buf[256];
  uint8_t *ptr = obex_create_request(&mas_obex, OBEX_OP_PUT, buf);
  uint8_t Fillerbyte = 0x30;
  
  ptr = obex_header_add_bytes(ptr, OBEX_HEADER_TYPE, (uint8_t*)type_notify, sizeof(type_notify));
  ptr = obex_header_add_bytes(ptr, OBEX_HEADER_APPPARMS, appparams_notify, sizeof(appparams_notify));
  ptr = obex_header_add_bytes(ptr, OBEX_HEADER_ENDBODY, &Fillerbyte, 1);
    
  obex_send(&mas_obex, buf, ptr - &buf[0]);

  obex_handle(&mas_obex, data1, sizeof(data1));
  obex_handle(&mas_obex, data2, sizeof(data2));

}

CuSuite* obexGetSuite(void)
{
	CuSuite* suite = CuSuiteNew("obex Test");

	SUITE_ADD_TEST(suite, testobex);
	return suite;
}


#include "CuTest.h"

#include <stdio.h>
#include <stdlib.h>
#include <memory.h>

#include "TestUtility/stlv_test_stub.h"
#include "stlv.h"
#include "stlv_client.h"
#include "stlv_server.h"
#include "stlv_transport.h"
#include "stlv_handler.h"

#ifndef NULL
#   define NULL 0
#endif

#define TEST_FILE_NAME "testfile"

static int trySendOut()
{
    int counter = 0;
    int prev_count = 0;
    do {
       prev_count = get_send_pack_stub_count();
       tryToSend();
    } while (prev_count != get_send_pack_stub_count());
    return counter;
}

static void TestSendEcho(CuTest* tc)
{
    init_send_pack_stub();

    uint8_t data[40];
    for (uint16_t i = 0; i < sizeof(data); ++i)
        data[i] = (uint8_t)i;
    send_echo(data, sizeof(data));
    trySendOut();

    CuAssertIntEquals(tc, 2,  get_send_pack_stub_count());

    send_pack_stub_t* node = get_send_pack_stub();

    CuAssertIntEquals(tc, 41, node->len);
    CuAssertIntEquals(tc, 0,  handle_stvl_transport(node->data, node->len));
    node = get_next_send_pack_stub(node);

    CuAssertIntEquals(tc, 7,  node->len);
    CuAssertIntEquals(tc, 46, handle_stvl_transport(node->data, node->len));

    reset_stlv_transport_buffer();
}


static void TestRecvEcho(CuTest* tc)
{
    uint8_t echo_data[] = {
        0x01, 0x80, 0x2a, 0x00, 0x45, 0x28, 0x00, 0x01, 0x02, 0x03,
        0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d,
        0x0e, 0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
        0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x21,
        0x22, 0x23, 0x24, 0x25, 0x26, 0x27,
    };

    init_send_pack_stub();
    handle_stlv_packet(echo_data);
    trySendOut();

    CuAssertIntEquals(tc, 2,  get_send_pack_stub_count());

    send_pack_stub_t* node = get_send_pack_stub();

    CuAssertIntEquals(tc, 41, node->len);
    CuAssertIntEquals(tc, 0,  handle_stvl_transport(node->data, node->len));
    node = get_next_send_pack_stub(node);

    CuAssertIntEquals(tc, 7,  node->len);
    CuAssertIntEquals(tc, 46, handle_stvl_transport(node->data, node->len));

    reset_stlv_transport_buffer();
}

static uint8_t file_buf[200];
static uint8_t file_index = 0;
static void send_file_callback(int para);

static void TestSendFile(CuTest* tc)
{
    printf("TestSendFile\n");
    init_send_pack_stub();

    for (int i = 0; i < (int)sizeof(file_buf); ++i)
        file_buf[i] = file_index;

    int fd = begin_send_file(TEST_FILE_NAME);
    send_file_data(fd, file_buf, sizeof(file_buf), send_file_callback, fd);

    trySendOut();

    CuAssertIntEquals(tc, 25, get_send_pack_stub_count());

    send_pack_stub_t* node = get_send_pack_stub();

    for (int i = 0; i < get_send_pack_stub_count(); ++i)
    {
        handle_stvl_transport(node->data, node->len);
        node = get_next_send_pack_stub(node);
    }
}

static void send_file_callback(int para)
{
    printf("callback para=%d\n", para);
    if (file_index == 3)
    {
        end_send_file(para);
        return;
    }

    file_index++;
    printf("callback index=%d\n", file_index);
    for (int i = 0; i < (int) sizeof(file_buf); ++i)
        file_buf[i] = file_index;

    send_file_data(para, file_buf, sizeof(file_buf), send_file_callback, para);

}

uint8_t file_begin_data[] = {
0x01, 0x80, 0xd6, 0x00, 0x46, 0xd4, 0x6e, 0x08, 0x74,
0x65, 0x73, 0x74, 0x66, 0x69, 0x6c, 0x65, 0x64, 0xc8,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00,
};

uint8_t file_data_data_0[] = {
0x01, 0x80, 0xcc, 0x00, 0x46, 0xf2, 0x64, 0xc9, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
0x01,
};

uint8_t file_data_data_1[] = {
0x01, 0x80, 0xcc, 0x00, 0x46, 0xf2, 0x64, 0xc9, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02,
0x02,
};

uint8_t file_data_data_2[] = {
0x01, 0x80, 0xcc, 0x00, 0x46, 0x9e, 0x64, 0xd0, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03,
};

uint8_t file_end_data[] = {
0x01, 0x80, 0x05, 0x00, 0x46, 0xf5, 0x65, 0xca, 0x00,
};

static void TestRecvFile(CuTest* tc)
{
    UNUSED_VAR(tc);
    cfs_coffee_format();
    init_send_pack_stub();

    handle_stlv_packet(file_begin_data);
    handle_stlv_packet(file_data_data_0);
    handle_stlv_packet(file_data_data_1);
    handle_stlv_packet(file_data_data_2);
    handle_stlv_packet(file_end_data);
}

static void TestListFiles(CuTest* tc)
{
    UNUSED_VAR(tc);
    handle_list_file();
    trySendOut();
}

static void TestGetFile(CuTest* tc)
{
    handle_get_file(TEST_FILE_NAME);
    trySendOut();

    CuAssertIntEquals(tc, 26,  get_send_pack_stub_count());
    send_pack_stub_t* node = get_send_pack_stub();
    CuAssertIntEquals(tc, 41, node->len);
    CuAssertIntEquals(tc, 0,  handle_stvl_transport(node->data, node->len));
    node = get_next_send_pack_stub(node);
}

static void TestRemoveFiles(CuTest* tc)
{
    UNUSED_VAR(tc);
    handle_remove_file(TEST_FILE_NAME);
}

static void TestSportsGrid(CuTest* tc)
{
    UNUSED_VAR(tc);
    handle_get_sports_grid();
    handle_get_sports_grid();
    handle_get_sports_grid();
    handle_get_sports_grid();
    handle_get_sports_grid();
}

static void TestAlarmConf(CuTest* tc)
{
    UNUSED_VAR(tc);

    alarm_conf_t alarmConf;

    alarmConf.id           = 1;
    alarmConf.mode         = ALARM_MODE_MONTHLY;
    alarmConf.day_of_month = 10;
    alarmConf.day_of_week  = 20;
    alarmConf.hour         = 12;
    alarmConf.minute       = 56;
    send_alarm_conf(&alarmConf);

    trySendOut();
}

static void TestNotification(CuTest* tc)
{
    UNUSED_VAR(tc);

}

static void TestGooglNow(CuTest* tc)
{
    UNUSED_VAR(tc);
    for (int i = 0; i < 10; ++i)
    {
        launch_google_now();
        trySendOut();
    }
}

CuSuite* StlvProtocalGetSuite(void)
{
	CuSuite* suite = CuSuiteNew("STLV Test");
    SUITE_ADD_TEST(suite, TestSendEcho);
    SUITE_ADD_TEST(suite, TestRecvEcho);
    SUITE_ADD_TEST(suite, TestSendFile);
    SUITE_ADD_TEST(suite, TestRecvFile);
    SUITE_ADD_TEST(suite, TestGetFile);
    SUITE_ADD_TEST(suite, TestSportsGrid);
    SUITE_ADD_TEST(suite, TestAlarmConf);
    SUITE_ADD_TEST(suite, TestNotification);
    SUITE_ADD_TEST(suite, TestGooglNow);
    return suite;
}

